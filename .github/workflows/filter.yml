name: Fast Filter PGN by NimsiluBot Wins/Draws (Clean Games)

on:
  workflow_dispatch:
    inputs:
      input_pgn:
        description: "Enter the PGN file name (e.g., NimsiluBot.pgn)"
        required: true
        default: "NimsiluBot.pgn"
      player_name:
        description: "Enter the player's name to filter games for"
        required: true
        default: "NimsiluBot"

jobs:
  filter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install pgn-extract
        run: |
          sudo apt-get update
          sudo apt-get install -y pgn-extract

      - name: Filter PGN for NimsiluBot (Wins/Draws & Legal Moves)
        run: |
          INPUT="${{ github.event.inputs.input_pgn }}"
          PLAYER="${{ github.event.inputs.player_name }}"
          OUTPUT="FilteredGames.pgn"
          TEMP="temp_filtered.pgn"

          if [ ! -f "$INPUT" ]; then
            echo "❌ File not found: $INPUT"
            exit 1
          fi

          echo "⚡ Filtering games for $PLAYER (removing illegal moves) using pgn-extract..."

          # Step 1: Extract games where NimsiluBot was White
          pgn-extract "$INPUT" \
            -t "White=$PLAYER" \
            -V \
            -o temp_white.pgn \
            --quiet

          # Step 2: Extract games where NimsiluBot was Black
          pgn-extract "$INPUT" \
            -t "Black=$PLAYER" \
            -V \
            -o temp_black.pgn \
            --quiet

          # Merge White+Black games
          cat temp_white.pgn temp_black.pgn > "$TEMP"

          # Step 3: Keep only wins or draws and validate again
          pgn-extract "$TEMP" \
            -r "1-0" \
            -r "0-1" \
            -r "1/2-1/2" \
            -V \
            -o "$OUTPUT" \
            --quiet

          if [ -s "$OUTPUT" ]; then
            echo "✅ Filter complete. Saved cleaned results to $OUTPUT"
          else
            echo "⚠️ No valid games found for $PLAYER"
            touch "$OUTPUT"
          fi

          rm -f temp_white.pgn temp_black.pgn "$TEMP"

      - name: Commit and Push Filtered PGN
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f "FilteredGames.pgn" ]; then
            git add "FilteredGames.pgn"
            git commit -m "Filtered PGN: Wins/Draws for NimsiluBot (Cleaned illegal moves)" || echo "No changes to commit"
            git push

