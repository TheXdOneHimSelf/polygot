name: Fast Filter PGN by NimsiluBot Wins/Draws (Legal Games)

on:
  workflow_dispatch:
    inputs:
      input_pgn:
        description: "Enter the PGN file name (e.g., NimsiluBot.pgn)"
        required: true
        default: "NimsiluBot.pgn"
      player_name:
        description: "Enter the player's name to filter games for"
        required: true
        default: "NimsiluBot"

jobs:
  filter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install latest pgn-extract
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential wget unzip
          wget https://www.cs.kent.ac.uk/people/staff/djb/pgn-extract/pgn-extract-21-10.zip -O pgn.zip
          unzip pgn.zip
          cd pgn-extract-21-10/src
          make
          sudo cp pgn-extract /usr/local/bin/
          cd ../..

      - name: Filter PGN for NimsiluBot (Legal Games Only)
        run: |
          INPUT="${{ github.event.inputs.input_pgn }}"
          PLAYER="${{ github.event.inputs.player_name }}"
          OUTPUT="FilteredGames.pgn"

          if [ ! -f "$INPUT" ]; then
            echo "❌ File not found: $INPUT"
            exit 1
          fi

          echo "⚡ Filtering valid games for $PLAYER (wins/draws only)..."

          # Create tagfiles for White and Black filters
          echo "White=$PLAYER" > white_tags.txt
          echo "Black=$PLAYER" > black_tags.txt

          # Extract White games, validate moves
          /usr/local/bin/pgn-extract "$INPUT" \
            -t white_tags.txt \
            -V \
            -o temp_white.pgn \
            --quiet || true

          # Extract Black games, validate moves
          /usr/local/bin/pgn-extract "$INPUT" \
            -t black_tags.txt \
            -V \
            -o temp_black.pgn \
            --quiet || true

          # Merge White and Black games
          cat temp_white.pgn temp_black.pgn > temp_all.pgn

          # Filter for wins/draws only
          /usr/local/bin/pgn-extract temp_all.pgn \
            -r "1-0" \
            -r "0-1" \
            -r "1/2-1/2" \
            -V \
            -o "$OUTPUT" \
            --quiet || true

          if [ -s "$OUTPUT" ]; then
            echo "✅ Successfully saved cleaned filtered PGN to $OUTPUT"
          else
            echo "⚠️ No valid wins/draws found for $PLAYER"
            touch "$OUTPUT"
          fi

          rm -f temp_white.pgn temp_black.pgn temp_all.pgn white_tags.txt black_tags.txt

      - name: Commit and Push Filtered PGN
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f "FilteredGames.pgn" ]; then
            git add "FilteredGames.pgn"
            git commit -m "Filtered PGN: Wins/Draws for NimsiluBot (Clean & Legal)" || echo "No changes to commit"
            git push


