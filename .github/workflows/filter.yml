name: Filter PGN by NimsiluBot Wins/Draws (No Python)

on:
  workflow_dispatch:
    inputs:
      input_pgn:
        description: "Enter the PGN file name (e.g., NimsiluBot.pgn)"
        required: true
        default: "NimsiluBot.pgn"
      player_name:
        description: "Enter the player's name to filter games for"
        required: true
        default: "NimsiluBot"

jobs:
  filter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Filter PGN for NimsiluBot
        run: |
          INPUT="${{ github.event.inputs.input_pgn }}"
          PLAYER="${{ github.event.inputs.player_name }}"
          OUTPUT="FilteredGames.pgn"

          if [ ! -f "$INPUT" ]; then
            echo "‚ùå File not found: $INPUT"
            exit 1
          fi

          echo "üîé Filtering games for player: $PLAYER (wins/draws only)"

          # Split PGN into separate files per game
          csplit -s -z "$INPUT" '/^\[Event/' '{*}' || true

          MATCHED=0

          for FILE in xx*; do
            # Check if NimsiluBot played in the game
            if ! grep -qiE "\[White \".*${PLAYER}.*\"|\[Black \".*${PLAYER}.*\"" "$FILE"; then
              rm "$FILE"
              continue
            fi

            # Keep only wins or draws for NimsiluBot
            if grep -qi "\[White \".*${PLAYER}.*\"" "$FILE"; then
              if ! grep -qE "\[Result \"(1-0|1/2-1/2)\"" "$FILE"; then
                rm "$FILE"
                continue
              fi
            fi

            if grep -qi "\[Black \".*${PLAYER}.*\"" "$FILE"; then
              if ! grep -qE "\[Result \"(0-1|1/2-1/2)\"" "$FILE"; then
                rm "$FILE"
                continue
              fi
            fi

            # Approximate illegal move check (drops game if contains suspicious tokens)
            if grep -qE "(\?\?|illegal|Invalid)" "$FILE"; then
              rm "$FILE"
              continue
            fi

            MATCHED=$((MATCHED+1))
          done

          # Merge kept games
          if [ $MATCHED -gt 0 ]; then
            cat xx* > "$OUTPUT"
            echo "‚úÖ Saved $MATCHED games for NimsiluBot to $OUTPUT"
          else
            echo "‚ö†Ô∏è No valid games found for NimsiluBot"
            touch "$OUTPUT"
          fi

          # Clean up temp files
          rm -f xx*
      
      - name: Commit and Push Filtered PGN
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f "FilteredGames.pgn" ]; then
            git add "FilteredGames.pgn"
            git commit -m "Filtered PGN: Wins/Draws (No Python) for NimsiluBot" || echo "No changes to commit"
            git push
          else
            echo "‚ö†Ô∏è No output PGN generated."
