name: Fast Filter PGN by NimsiluBot Wins/Draws

on:
  workflow_dispatch:
    inputs:
      input_pgn:
        description: "Enter the PGN file name (e.g., NimsiluBot.pgn)"
        required: true
        default: "NimsiluBot.pgn"
      player_name:
        description: "Enter the player's name to filter games for"
        required: true
        default: "NimsiluBot"

jobs:
  filter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install pgn-extract (fast PGN processing tool)
        run: |
          sudo apt-get update
          sudo apt-get install -y pgn-extract

      - name: Filter PGN for NimsiluBot (Wins/Draws Only)
        run: |
          INPUT="${{ github.event.inputs.input_pgn }}"
          PLAYER="${{ github.event.inputs.player_name }}"
          OUTPUT="FilteredGames.pgn"

          if [ ! -f "$INPUT" ]; then
            echo "❌ File not found: $INPUT"
            exit 1
          fi

          echo "⚡ Filtering games for $PLAYER using pgn-extract..."

          # Filter games where NimsiluBot played and result is win or draw
          pgn-extract "$INPUT" \
            -p "$PLAYER" \
            -r "1-0" -r "0-1" -r "1/2-1/2" \
            -o "$OUTPUT" \
            --quiet

          if [ -s "$OUTPUT" ]; then
            echo "✅ Filter complete. Saved results to $OUTPUT"
          else
            echo "⚠️ No matching games found for $PLAYER"
            touch "$OUTPUT"
          fi

      - name: Commit and Push Filtered PGN
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f "FilteredGames.pgn" ]; then
            git add "FilteredGames.pgn"
            git commit -m "Filtered PGN: Wins/Draws for NimsiluBot (Fast pgn-extract)" || echo "No changes to commit"
            git push
